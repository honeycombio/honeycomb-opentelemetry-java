version: 2.1

orbs:
  gradle: circleci/gradle@2.2.0

jobs:
  build:
    executor:
      name: gradle/default
      tag: "17.0"
    steps:
      - checkout
      - run: mkdir -p ~/build-artifacts
      - gradle/with_cache:
          steps:
            - run: ./gradlew build -x test
      - run:
          name: Copy JARs to build-artifacts
          command: |
            shopt -s globstar
            cp **/build/libs/*.jar ~/build-artifacts
      - persist_to_workspace:
          root: ~/
          paths:
            - build-artifacts

  smoke_test:
    docker:
      - image: cimg/base:stable
    environment:
      AGENT_JAR_GLOB: $HOME/build-artifacts/honeycomb-opentelemetry-javaagent*-all.jar
      AGENT_ONLY_APP_JAR_GLOB: $HOME/build-artifacts/spring-agent-only-?.?.?.jar
      AGENT_MANUAL_APP_JAR_GLOB: $HOME/build-artifacts/spring-agent-manual-?.?.?.jar
    steps:
      - attach_workspace:
          at: ~/
      - setup_remote_docker:
          version: 20.10.7
      - checkout
      - run:
          name: Smoke Test
          command: |
            cp $(eval "echo $AGENT_JAR_GLOB") ./smoke-tests/smoke-tests-agent-only/agent.jar
            cp $(eval "echo $AGENT_ONLY_APP_JAR_GLOB") ./smoke-tests/smoke-tests-agent-only/app.jar
            cp $(eval "echo $AGENT_JAR_GLOB") ./smoke-tests/smoke-tests-agent-manual/agent.jar
            cp $(eval "echo $AGENT_MANUAL_APP_JAR_GLOB") ./smoke-tests/smoke-tests-agent-manual/app.jar
            make smoke

  publish_github:
    docker:
      - image: cibuilds/github:0.13.0
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: "Publish Release on GitHub"
          command: |
            echo "about to publish to tag ${CIRCLE_TAG}"
            ls -l ~/publish-artifacts/*
            ghr -draft -n ${CIRCLE_TAG} -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} ${CIRCLE_TAG} ~/publish-artifacts
  publish_maven:
    executor: gradle/default
    steps:
      - checkout
      - gradle/with_cache:
          steps:
            - run: mkdir -p ~/publish-artifacts
            - run:
                name: "Publish Artifacts to Maven"
                command: ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository
            - run:
                command: |
                  shopt -s globstar
                  cp **/build/libs/*.jar ~/publish-artifacts
            - persist_to_workspace:
                root: ~/
                paths:
                  - publish-artifacts
            - store_artifacts:
                path: ~/publish-artifacts

filters_always: &filters_always
  filters:
    tags:
      only: /.*/

filters_publish: &filters_publish
  filters:
    tags:
      only: /^v.*/
    branches:
      ignore: /.*/

matrix_executors: &matrix_executors
  matrix:
    parameters:
      executor:
        - name: gradle/default
          tag: "8.0"
        - name: gradle/default
          tag: "11.0"
        - name: gradle/default
          tag: "17.0"

workflows:
  version: 2
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - gradle/test:
          <<: *matrix_executors
      - build:
          requires:
            - gradle/test
      - smoke_test:
          requires:
            - build
  build:
    jobs:
      - gradle/test:
          <<: *matrix_executors
          <<: *filters_always
      - build:
          requires:
            - gradle/test
          <<: *filters_always
      - smoke_test:
          <<: *filters_always
          requires:
            - build
      - publish_github:
          context: Honeycomb Secrets for Public Repos
          requires:
            - publish_maven
          <<: *filters_publish
      - publish_maven:
          context: java_beeline
          requires:
            - build
          <<: *filters_publish
